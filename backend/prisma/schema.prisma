// Prisma Schema para Sistema de Ponto

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUPERVISOR
  ESTAGIARIO
  AUDIT
}

enum AttendanceType {
  ENTRADA
  SAIDA
}

enum CorrectionStatus {
  PENDENTE
  APROVADO
  REJEITADO
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  name              String
  password          String?
  role              UserRole            @default(ESTAGIARIO)
  googleId          String?             @unique
  twoFactorSecret   String?
  twoFactorEnabled  Boolean             @default(false)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Dados do contrato (para estagiários)
  contractStartDate DateTime?
  contractEndDate   DateTime?
  totalContractHours Int?              // Carga horária total do contrato (ex: 800h)
  weeklyHours       Int?               @default(30) // Horas semanais (padrão: 30h)
  dailyHours        Int?               @default(6)  // Horas diárias (padrão: 6h)
  
  // Relações
  attendanceRecords AttendanceRecord[]
  corrections       AttendanceCorrection[]
  auditLogs         AuditLog[]
  refreshTokens     RefreshToken[]
  workSummaries     WorkSummary[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

model Machine {
  id              String              @id @default(uuid())
  name            String
  location        String
  timezone        String              @default("America/Sao_Paulo")
  publicId        String              @unique
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relações
  qrEvents        MachineQrEvent[]
  attendanceRecords AttendanceRecord[]

  @@index([publicId])
  @@map("machines")
}

model MachineQrEvent {
  id          String    @id @default(uuid())
  machineId   String
  payload     String    @db.Text
  signature   String    @db.Text
  nonce       String
  tsGenerated DateTime  @default(now())
  expiresAt   DateTime
  
  // Relações
  machine     Machine   @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId, tsGenerated])
  @@index([nonce])
  @@map("machine_qr_events")
}

model AttendanceRecord {
  id            String          @id @default(uuid())
  userId        String
  machineId     String
  type          AttendanceType
  tsClient      DateTime
  tsServer      DateTime        @default(now())
  nonce         String          @unique
  
  // Dados opcionais
  selfieUrl     String?
  geoLat        Float?
  geoLng        Float?
  deviceInfo    String?
  userAgent     String?
  
  // Hash chain para auditoria imutável
  prevHash      String?
  recordHash    String
  
  // Relações
  user          User            @relation(fields: [userId], references: [id])
  machine       Machine         @relation(fields: [machineId], references: [id])
  correction    AttendanceCorrection?

  @@index([userId, tsServer])
  @@index([machineId, tsServer])
  @@index([nonce])
  @@index([recordHash])
  @@map("attendance_records")
}

model AttendanceCorrection {
  id                  String            @id @default(uuid())
  attendanceRecordId  String            @unique
  userId              String
  reason              String            @db.Text
  newType             AttendanceType?
  newTimestamp        DateTime?
  status              CorrectionStatus  @default(PENDENTE)
  reviewedBy          String?
  reviewedAt          DateTime?
  reviewNotes         String?           @db.Text
  createdAt           DateTime          @default(now())
  
  // Relações
  attendanceRecord    AttendanceRecord  @relation(fields: [attendanceRecordId], references: [id])
  user                User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("attendance_corrections")
}

model Nonce {
  id          String    @id @default(uuid())
  machineId   String
  nonce       String
  ts          DateTime  @default(now())
  expiresAt   DateTime

  @@unique([machineId, nonce])
  @@index([expiresAt])
  @@map("nonces")
}

model AuditLog {
  id          String    @id @default(uuid())
  actorId     String?
  action      String
  resource    String
  resourceId  String?
  details     String?   @db.Text
  ipAddress   String?
  userAgent   String?
  ts          DateTime  @default(now())
  
  // Relações
  actor       User?     @relation(fields: [actorId], references: [id])

  @@index([actorId, ts])
  @@index([resource, ts])
  @@map("audit_logs")
}

model RefreshToken {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  
  // Relações
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Resumo de trabalho diário (calculado automaticamente)
model WorkSummary {
  id                String    @id @default(uuid())
  userId            String
  date              DateTime  @db.Date
  
  // Horários
  firstEntry        DateTime?
  lastExit          DateTime?
  
  // Cálculos
  totalMinutes      Int       @default(0) // Total de minutos trabalhados
  breakMinutes      Int       @default(0) // Minutos de intervalo
  workedMinutes     Int       @default(0) // Minutos efetivamente trabalhados
  
  // Validações
  hasIncomplete     Boolean   @default(false) // Entrada sem saída
  hasExtraHours     Boolean   @default(false) // Horas extras
  hasViolation      Boolean   @default(false) // Violação de jornada
  violationReason   String?
  
  // Contadores
  entriesCount      Int       @default(0)
  exitsCount        Int       @default(0)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relações
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
  @@map("work_summaries")
}
