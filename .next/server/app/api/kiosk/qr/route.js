"use strict";(()=>{var e={};e.id=4475,e.ids=[4475],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},59600:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{GET:()=>d});var o=t(49303),i=t(88716),n=t(60670),s=t(87070),u=t(83493),l=t(64242);async function d(e){try{console.log("Kiosk QR API called");let e=await u._.machine.findFirst({where:{isActive:!0}});if(!e){let e=await u._.machine.create({data:{name:"Kiosk Principal",location:"Entrada Principal",isActive:!0}});return c(e.id,e.name,e.location)}return c(e.id,e.name,e.location)}catch(e){return console.error("Erro ao gerar QR code do kiosk:",e),s.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function c(e,r,t){console.log("\uD83D\uDD10 Gerando QR code seguro para m\xe1quina:",e);let a=(0,l.UP)(e),o=new Date(Date.now()+6e4);return await u._.qrEvent.create({data:{machineId:e,qrData:a.fullQR,nonce:JSON.parse(Buffer.from(a.payload,"base64url").toString()).nonce,expiresAt:o,used:!1}}),console.log("âœ… QR code seguro gerado com sucesso"),s.NextResponse.json({qrData:a.fullQR,machineId:e,machineName:r,location:t,expiresAt:o.toISOString(),validFor:60,security:{signed:!0,algorithm:"HMAC-SHA256",version:"v1"}})}let p=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/kiosk/qr/route",pathname:"/api/kiosk/qr",filename:"route",bundlePath:"app/api/kiosk/qr/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/kiosk/qr/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=p,h="/api/kiosk/qr/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},83493:(e,r,t)=>{t.d(r,{_:()=>o});let a=require("@prisma/client"),o=globalThis.prisma??new a.PrismaClient},64242:(e,r,t)=>{t.d(r,{RE:()=>c,Sr:()=>d,T4:()=>l,UP:()=>n,vg:()=>s});var a=t(84770),o=t.n(a);let i=process.env.QR_SECRET||"chronos-qr-secret-key-2024";function n(e){let r=o().randomBytes(16).toString("hex"),t=JSON.stringify({machineId:e,timestamp:Date.now(),nonce:r,expiresIn:60,version:"v1"}),a=Buffer.from(t).toString("base64url"),n=o().createHmac("sha256",i).update(a).digest("base64url"),s=`${a}.${n}`;return{payload:a,signature:n,fullQR:s}}function s(e){try{let r=e.split(".");if(2!==r.length)return{isValid:!1,error:"Formato de QR inv\xe1lido"};let[t,a]=r,n=o().createHmac("sha256",i).update(t).digest("base64url");if(!o().timingSafeEqual(Buffer.from(n,"base64url"),Buffer.from(a,"base64url")))return{isValid:!1,error:"Assinatura inv\xe1lida"};let s=Buffer.from(t,"base64url").toString("utf8"),u=JSON.parse(s),l=Date.now(),d=u.timestamp+1e3*u.expiresIn;if(l>d)return{isValid:!1,error:"QR code expirado"};if(!u.machineId||!u.nonce||!u.timestamp)return{isValid:!1,error:"Payload inv\xe1lido"};return{isValid:!0,payload:u}}catch(e){return{isValid:!1,error:"Erro ao validar QR code"}}}let u=new Map;function l(e){let r=Date.now()-3e5;for(let[e,t]of Array.from(u.entries()))t<r&&u.delete(e);return u.has(e)}function d(e){u.set(e,Date.now())}function c(e,r,t,a,i){let n=`${e}:${r}:${t}:${a}:${i||""}`;return o().createHash("sha256").update(n).digest("hex")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9276,5972],()=>t(59600));module.exports=a})();