"use strict";(()=>{var e={};e.id=4475,e.ids=[4475],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},59600:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{GET:()=>l});var o=t(49303),i=t(88716),n=t(60670),s=t(87070),u=t(83493),d=t(64242);async function l(e){try{let e=await u._.machine.findFirst({where:{isActive:!0}});if(!e){let e=await u._.machine.create({data:{name:"Kiosk Principal",location:"Entrada Principal",isActive:!0}});return p(e.id,e.name,e.location)}return p(e.id,e.name,e.location)}catch(e){return s.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function p(e,r,t){try{let a,o,i;let n=(0,d.UP)(e,60);try{let e=Buffer.from(n.payload,"base64url").toString("utf8");if(!(o=JSON.parse(e)).nonce)throw Error("Nonce n\xe3o encontrado no payload");if(!o.timestamp)throw Error("Timestamp n\xe3o encontrado no payload");if(!o.expiresIn)throw Error("expiresIn n\xe3o encontrado no payload");a=o.nonce,i=new Date(o.timestamp+1e3*o.expiresIn)}catch(e){throw Error(`Erro ao gerar QR code: ${e.message}`)}return await u._.qrEvent.create({data:{machineId:e,qrData:n.fullQR,nonce:a,expiresAt:i,used:!1}}),s.NextResponse.json({qrData:n.fullQR,machineId:e,machineName:r,location:t,expiresAt:i.toISOString(),validFor:o.expiresIn,security:{signed:!0,algorithm:"HMAC-SHA256",version:"v1"}})}catch(e){if(e.message&&e.message.includes("QR_SECRET"))return s.NextResponse.json({error:"Erro de configura\xe7\xe3o: QR_SECRET n\xe3o est\xe1 configurado no servidor",details:e.message},{status:500});throw e}}let c=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/kiosk/qr/route",pathname:"/api/kiosk/qr",filename:"route",bundlePath:"app/api/kiosk/qr/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/kiosk/qr/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h}=c,g="/api/kiosk/qr/route";function v(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},83493:(e,r,t)=>{t.d(r,{_:()=>o});let a=require("@prisma/client"),o=globalThis.prisma??new a.PrismaClient},64242:(e,r,t)=>{t.d(r,{RE:()=>u,UP:()=>n,vg:()=>s});var a=t(84770),o=t.n(a);let i=process.env.QR_SECRET;if(!i)throw Error("QR_SECRET environment variable is required");function n(e,r=60){!function(){if(!i)throw Error("QR_SECRET n\xe3o est\xe1 configurado. Configure a vari\xe1vel de ambiente QR_SECRET.")}();let t=o().randomBytes(16).toString("hex"),a=JSON.stringify({machineId:e,timestamp:Date.now(),nonce:t,expiresIn:r,version:"v1"}),n=Buffer.from(a).toString("base64url"),s=o().createHmac("sha256",i).update(n).digest("base64url"),u=`${n}.${s}`;return{payload:n,signature:s,fullQR:u}}function s(e){try{if(!i)return{isValid:!1,error:"QR_SECRET n\xe3o est\xe1 configurado no servidor"};let r=e.split(".");if(2!==r.length)return{isValid:!1,error:"Formato de QR inv\xe1lido. Esperado: payload.signature"};let[t,a]=r,n=o().createHmac("sha256",i).update(t).digest("base64url");if(!o().timingSafeEqual(Buffer.from(n,"base64url"),Buffer.from(a,"base64url")))return{isValid:!1,error:"Assinatura inv\xe1lida"};let s=Buffer.from(t,"base64url").toString("utf8"),u=JSON.parse(s),d=Date.now(),l=u.timestamp+1e3*u.expiresIn;if(d>l)return{isValid:!1,error:"QR code expirado"};if(!u.machineId||!u.nonce||!u.timestamp)return{isValid:!1,error:"Payload inv\xe1lido"};return{isValid:!0,payload:u}}catch(e){return{isValid:!1,error:"Erro ao validar QR code"}}}function u(e,r,t,a,i){let n=`${e}:${r}:${t}:${a}:${i||""}`;return o().createHash("sha256").update(n).digest("hex")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9276,5972],()=>t(59600));module.exports=a})();