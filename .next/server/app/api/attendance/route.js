"use strict";(()=>{var e={};e.id=1996,e.ids=[1996],e.modules={98432:e=>{e.exports=require("bcryptjs")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},1325:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>I,requestAsyncStorage:()=>_,routeModule:()=>H,serverHooks:()=>q,staticGenerationAsyncStorage:()=>D});var a={};r.r(a),r.d(a,{GET:()=>T,POST:()=>R,dynamic:()=>x});var i=r(49303),o=r(88716),n=r(60670),s=r(87070),l=r(75571),u=r(90455),d=r(83493);let c={FUNDAMENTAL_20H:{dailyHours:4,weeklyHours:20},SUPERIOR_30H:{dailyHours:6,weeklyHours:30},ALTERNANCIA_40H:{dailyHours:8,weeklyHours:40},CUSTOM:{dailyHours:6,weeklyHours:30}};async function p(e,t=new Date){try{let r=await d._.user.findUnique({where:{id:e},select:{contractType:!0,weeklyHours:!0,dailyHours:!0}});if(!r)throw Error("Usu\xe1rio n\xe3o encontrado");let a=new Date(t);a.setHours(0,0,0,0);let i=new Date(t);i.setHours(23,59,59,999);let o=await d._.attendanceRecord.findMany({where:{userId:e,timestamp:{gte:a,lte:i}},orderBy:{timestamp:"asc"}}),n=0,s=!1;for(let e=0;e<o.length-1;e+=2){let t=o[e],r=o[e+1];if("ENTRY"===t.type&&r&&"EXIT"===r.type){let e=r.timestamp.getTime()-t.timestamp.getTime();n+=e/36e5,s=!0}}if(o.length%2==1&&"ENTRY"===o[o.length-1].type){let e=o[o.length-1],r=new Date;if(t.toDateString()===r.toDateString()){let t=r.getTime()-e.timestamp.getTime();n+=t/36e5,s=!1}}let l=c[r.contractType]||c.CUSTOM,u="CUSTOM"===r.contractType?r.dailyHours:l.dailyHours,p=n-u,m=new Date(t);m.setDate(t.getDate()-t.getDay()),m.setHours(0,0,0,0);let h=new Date(m);h.setDate(m.getDate()+6),h.setHours(23,59,59,999);let w=(await d._.hourBalance.findMany({where:{userId:e,date:{gte:m,lte:h}}})).reduce((e,t)=>e+t.balance,0)+p,g=new Date(t.getFullYear(),t.getMonth(),1),y=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),f=(await d._.hourBalance.findMany({where:{userId:e,date:{gte:g,lte:y}}})).reduce((e,t)=>e+t.balance,0)+p;return{workedHours:n,expectedHours:u,dailyBalance:p,weeklyBalance:w,monthlyBalance:f,isComplete:s}}catch(e){throw e}}async function m(e,t=new Date){try{let r=await p(e,t),a=new Date(t);a.setHours(0,0,0,0);let i=new Date(t);i.setHours(23,59,59,999);let o=await d._.hourBalance.findFirst({where:{userId:e,date:{gte:a,lte:i}}}),n={workedHours:r.workedHours,expectedHours:r.expectedHours,balance:r.dailyBalance,weeklyBalance:r.weeklyBalance,monthlyBalance:r.monthlyBalance,description:r.isComplete?"Dia completo":"Em andamento"};o?await d._.hourBalance.update({where:{id:o.id},data:n}):await d._.hourBalance.create({data:{userId:e,date:t,...n}});let s=await d._.hourBalance.aggregate({where:{userId:e},_sum:{balance:!0}});await d._.user.update({where:{id:e},data:{hourBalance:s._sum.balance||0}})}catch(e){throw e}}async function h(e,t,r){try{let a=await d._.user.findUnique({where:{id:e},select:{contractType:!0,dailyHours:!0,weeklyHours:!0}});if(!a)throw Error("Usu\xe1rio n\xe3o encontrado");let i=[],o=[];if(r){let e=(r.getTime()-t.getTime())/36e5,n=c[a.contractType],s="CUSTOM"===a.contractType?a.dailyHours:n.dailyHours;e>s&&i.push(`Excede limite di\xe1rio: ${e.toFixed(2)}h > ${s}h`),e>.9*s&&o.push(`Pr\xf3ximo do limite di\xe1rio: ${e.toFixed(2)}h`)}let n=t.getHours(),s=r?.getHours();return(n<6||n>22)&&o.push("Hor\xe1rio de entrada fora do per\xedodo recomendado (6h-22h)"),s&&(s<6||s>22)&&o.push("Hor\xe1rio de sa\xedda fora do per\xedodo recomendado (6h-22h)"),{isValid:0===i.length,violations:i,warnings:o}}catch(e){throw e}}var w=r(91585),g=r(26033),y=r(84770),f=r.n(y);let x="force-dynamic",E=w.Ry({machineId:w.Z_().cuid(),type:w.Km(["ENTRY","EXIT"]),qrData:w.Z_(),latitude:w.Rx().optional(),longitude:w.Rx().optional()});async function T(e){try{let t=await (0,l.getServerSession)(u.L);if(!t)return s.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("userId")||t.user.id,i=r.get("machineId"),o=r.get("startDate"),n=r.get("endDate"),c=parseInt(r.get("page")||"1"),p=parseInt(r.get("limit")||"20"),m=["ADMIN","SUPERVISOR"].includes(t.user.role);if(!m&&a!==t.user.id)return s.NextResponse.json({error:"N\xe3o autorizado"},{status:403});let h={};a&&(m||a===t.user.id)?h.userId=a:m||(h.userId=t.user.id),i&&(h.machineId=i),(o||n)&&(h.timestamp={},o&&(h.timestamp.gte=new Date(o)),n&&(h.timestamp.lte=new Date(n)));let[w,g]=await Promise.all([d._.attendanceRecord.findMany({where:h,include:{user:{select:{name:!0,email:!0}},machine:{select:{name:!0,location:!0}}},skip:(c-1)*p,take:p,orderBy:{timestamp:"desc"}}),d._.attendanceRecord.count({where:h})]);return s.NextResponse.json({records:w,pagination:{page:c,limit:p,total:g,pages:Math.ceil(g/p)}})}catch(e){return s.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function R(e){try{let t=await (0,l.getServerSession)(u.L);if(!t)return s.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let r=await e.json(),a=E.parse(r),i=await d._.machine.findUnique({where:{id:a.machineId}});if(!i||!i.isActive)return s.NextResponse.json({error:"M\xe1quina n\xe3o encontrada ou inativa"},{status:400});let o=await d._.attendanceRecord.findFirst({where:{userId:t.user.id},orderBy:{timestamp:"desc"}}),n=o&&"EXIT"!==o.type?"EXIT":"ENTRY";if(a.type!==n)return s.NextResponse.json({error:"ENTRY"===n?"Voc\xea deve registrar uma entrada primeiro":"Voc\xea deve registrar uma sa\xedda primeiro"},{status:400});let c=`${t.user.id}-${a.machineId}-${a.type}-${Date.now()}`,p=f().createHash("sha256").update(c).digest("hex"),w=await d._.attendanceRecord.create({data:{userId:t.user.id,machineId:a.machineId,type:a.type,qrData:a.qrData,latitude:a.latitude,longitude:a.longitude,hash:p,prevHash:o?.hash},include:{user:{select:{name:!0,email:!0}},machine:{select:{name:!0,location:!0}}}});try{if("EXIT"===a.type&&o){let e=await h(t.user.id,o.timestamp,w.timestamp);e.isValid,e.warnings.length}await m(t.user.id,w.timestamp)}catch(e){}return await d._.auditLog.create({data:{userId:t.user.id,action:"CREATE_ATTENDANCE",resource:"ATTENDANCE_RECORD",details:`Registro de ${a.type} na m\xe1quina ${i.name}`}}),s.NextResponse.json(w,{status:201})}catch(e){if(e instanceof g.jm)return s.NextResponse.json({error:"Dados inv\xe1lidos",details:e.errors},{status:400});return s.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let H=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/attendance/route",pathname:"/api/attendance",filename:"route",bundlePath:"app/api/attendance/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/attendance/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:D,serverHooks:q}=H,C="/api/attendance/route";function I(){return(0,n.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:D})}},90455:(e,t,r)=>{r.d(t,{L:()=>c});var a=r(13539),i=r(77234),o=r(53797),n=r(98432),s=r.n(n),l=r(83493);let u=process.env.GOOGLE_CLIENT_ID,d=process.env.GOOGLE_CLIENT_SECRET,c={adapter:(0,a.N)(l._),debug:!1,providers:[(0,o.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=await l._.user.findUnique({where:{email:e.email}});if(!t||!t.password||!await s().compare(e.password,t.password))return null;return{id:t.id,email:t.email,name:t.name,role:t.role,profileComplete:t.profileComplete,image:t.image}}catch(e){return null}}}),(0,i.Z)({clientId:u,clientSecret:d,allowDangerousEmailAccountLinking:!0})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin",error:"/auth/error"},callbacks:{async jwt({token:e,user:t,account:r,trigger:a}){if((t||"update"===a)&&(t&&(e.role=t.role,e.sub=t.id,e.profileComplete=t.profileComplete),e.sub)){let t=await l._.user.findUnique({where:{id:e.sub},select:{role:!0,profileComplete:!0,name:!0,email:!0}});t&&(e.role=t.role,e.profileComplete=t.profileComplete,e.name=t.name,e.email=t.email)}return e},session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.profileComplete=t.profileComplete),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{let t=await l._.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,role:!0,profileComplete:!0,image:!0}});if(t)e.id=t.id,e.role=t.role,e.profileComplete=t.profileComplete,e.name=t.name||e.name,e.image=t.image||e.image;else{let t=await l._.user.create({data:{email:e.email,name:e.name||"Usu\xe1rio",image:e.image,role:"EMPLOYEE",profileComplete:!1}});e.id=t.id,e.role=t.role,e.profileComplete=t.profileComplete}}catch(e){return!1}return!0},redirect:async({url:e,baseUrl:t})=>e.includes("/api/auth/callback/")?`${t}/`:e.startsWith("/")?`${t}${e}`:new URL(e).origin===t?e:t},secret:"test-secret-key-for-development"}},83493:(e,t,r)=>{r.d(t,{_:()=>i});let a=require("@prisma/client"),i=globalThis.prisma??new a.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,1083,1585],()=>r(1325));module.exports=a})();