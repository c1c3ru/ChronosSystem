"use strict";(()=>{var e={};e.id=1996,e.ids=[1996],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},41144:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>N,requestAsyncStorage:()=>y,routeModule:()=>R,serverHooks:()=>I,staticGenerationAsyncStorage:()=>q});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>E});var s=r(49303),n=r(88716),i=r(60670),o=r(87070),u=r(75571),d=r(90455),c=r(83493),p=r(91585),l=r(26033),m=r(84770),g=r.n(m);let x=p.Ry({machineId:p.Z_().cuid(),type:p.Km(["ENTRY","EXIT"]),qrData:p.Z_(),latitude:p.Rx().optional(),longitude:p.Rx().optional()});async function h(e){try{let t=await (0,u.getServerSession)(d.L);if(!t)return o.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("userId")||t.user.id,s=r.get("machineId"),n=r.get("startDate"),i=r.get("endDate"),p=parseInt(r.get("page")||"1"),l=parseInt(r.get("limit")||"20"),m=["ADMIN","SUPERVISOR"].includes(t.user.role);if(!m&&a!==t.user.id)return o.NextResponse.json({error:"N\xe3o autorizado"},{status:403});let g={};a&&(m||a===t.user.id)?g.userId=a:m||(g.userId=t.user.id),s&&(g.machineId=s),(n||i)&&(g.timestamp={},n&&(g.timestamp.gte=new Date(n)),i&&(g.timestamp.lte=new Date(i)));let[x,h]=await Promise.all([c._.attendanceRecord.findMany({where:g,include:{user:{select:{name:!0,email:!0}},machine:{select:{name:!0,location:!0}}},skip:(p-1)*l,take:l,orderBy:{timestamp:"desc"}}),c._.attendanceRecord.count({where:g})]);return o.NextResponse.json({records:x,pagination:{page:p,limit:l,total:h,pages:Math.ceil(h/l)}})}catch(e){return console.error("Erro ao buscar registros de ponto:",e),o.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function E(e){try{let t=await (0,u.getServerSession)(d.L);if(!t)return o.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let r=await e.json(),a=x.parse(r),s=await c._.machine.findUnique({where:{id:a.machineId}});if(!s||!s.isActive)return o.NextResponse.json({error:"M\xe1quina n\xe3o encontrada ou inativa"},{status:400});let n=await c._.attendanceRecord.findFirst({where:{userId:t.user.id},orderBy:{timestamp:"desc"}}),i=n&&"EXIT"!==n.type?"EXIT":"ENTRY";if(a.type!==i)return o.NextResponse.json({error:"ENTRY"===i?"Voc\xea deve registrar uma entrada primeiro":"Voc\xea deve registrar uma sa\xedda primeiro"},{status:400});let p=`${t.user.id}-${a.machineId}-${a.type}-${Date.now()}`,l=g().createHash("sha256").update(p).digest("hex"),m=await c._.attendanceRecord.create({data:{userId:t.user.id,machineId:a.machineId,type:a.type,qrData:a.qrData,latitude:a.latitude,longitude:a.longitude,hash:l,prevHash:n?.hash},include:{user:{select:{name:!0,email:!0}},machine:{select:{name:!0,location:!0}}}});return await c._.auditLog.create({data:{userId:t.user.id,action:"CREATE_ATTENDANCE",resource:"ATTENDANCE_RECORD",details:`Registro de ${a.type} na m\xe1quina ${s.name}`}}),o.NextResponse.json(m,{status:201})}catch(e){if(e instanceof l.jm)return o.NextResponse.json({error:"Dados inv\xe1lidos",details:e.errors},{status:400});return console.error("Erro ao criar registro de ponto:",e),o.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let R=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/attendance/route",pathname:"/api/attendance",filename:"route",bundlePath:"app/api/attendance/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/attendance/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:q,serverHooks:I}=R,v="/api/attendance/route";function N(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:q})}},90455:(e,t,r)=>{r.d(t,{L:()=>i});var a=r(13539),s=r(77234),n=r(83493);let i={adapter:(0,a.N)(n._),providers:[(0,s.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role||"EMPLOYEE",e.sub=t.id),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await n._.user.findUnique({where:{email:e.email}})||await n._.user.create({data:{email:e.email,name:e.name,image:e.image,role:"EMPLOYEE"}})}catch(e){return console.error("Erro ao criar usu\xe1rio:",e),!1}return!0}},pages:{signIn:"/auth/signin",error:"/auth/error"},secret:"chronos-secret-key-2024-production-ready"}},83493:(e,t,r)=>{r.d(t,{_:()=>s});let a=require("@prisma/client"),s=globalThis.prisma??new a.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,8966,1585],()=>r(41144));module.exports=a})();