"use strict";(()=>{var e={};e.id=1546,e.ids=[1546],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},82821:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>R,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var a={};t.r(a),t.d(a,{POST:()=>p});var s=t(49303),n=t(88716),o=t(60670),i=t(87070),u=t(75571),d=t(90455),c=t(83493),l=t(64242);async function p(e){try{let r=await (0,u.getServerSession)(d.L);if(!r)return i.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let{qrData:t}=await e.json();if(!t)return i.NextResponse.json({error:"QR code \xe9 obrigat\xf3rio"},{status:400});console.log("\uD83D\uDD0D Validando QR code seguro...");let a=(0,l.vg)(t);if(!a.isValid)return console.log("❌ QR code inv\xe1lido:",a.error),i.NextResponse.json({error:a.error},{status:400});let{machineId:s,nonce:n,timestamp:o}=a.payload;if(console.log("✅ QR code v\xe1lido - M\xe1quina:",s,"Nonce:",n.slice(0,8)+"..."),(0,l.T4)(n))return console.log("❌ Nonce j\xe1 foi usado:",n.slice(0,8)+"..."),i.NextResponse.json({error:"QR code j\xe1 foi utilizado (anti-replay)"},{status:400});let p=await c._.machine.findFirst({where:{id:s,isActive:!0}});if(!p)return i.NextResponse.json({error:"M\xe1quina n\xe3o encontrada ou inativa"},{status:400});console.log("\uD83D\uDD0D Verificando m\xe1quina e nonce no banco...");let m=await c._.attendanceRecord.findFirst({where:{userId:r.user.id},orderBy:{timestamp:"desc"}}),f=m&&"EXIT"!==m.type?"EXIT":"ENTRY",g=Date.now(),h=new Date(g-6e4);if(await c._.attendanceRecord.findFirst({where:{userId:r.user.id,timestamp:{gte:h},type:f}}))return i.NextResponse.json({error:`Registro de ${"ENTRY"===f?"entrada":"sa\xedda"} j\xe1 feito recentemente. Aguarde 1 minuto.`},{status:400});let x=await c._.attendanceRecord.findFirst({orderBy:{timestamp:"desc"},select:{hash:!0}}),R=(0,l.RE)(r.user.id,s,f,Date.now(),x?.hash),q=await c._.attendanceRecord.create({data:{userId:r.user.id,machineId:s,type:f,timestamp:new Date,qrData:t,hash:R}});(0,l.Sr)(n);let E=await c._.qrEvent.findFirst({where:{nonce:n}});return E&&await c._.qrEvent.update({where:{id:E.id},data:{used:!0,usedAt:new Date,usedBy:r.user.id}}),await c._.auditLog.create({data:{userId:r.user.id,action:"QR_SCAN_ATTENDANCE",resource:"ATTENDANCE_RECORD",details:`Registro de ${f} via QR code na m\xe1quina ${p.name}`}}),i.NextResponse.json({success:!0,record:{id:q.id,type:f,timestamp:q.timestamp,location:p.location,machineName:p.name},message:`${"ENTRY"===f?"Entrada":"Sa\xedda"} registrada com sucesso!`})}catch(e){return console.error("Erro ao processar QR scan:",e),i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/attendance/qr-scan/route",pathname:"/api/attendance/qr-scan",filename:"route",bundlePath:"app/api/attendance/qr-scan/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/attendance/qr-scan/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:h}=m,x="/api/attendance/qr-scan/route";function R(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},90455:(e,r,t)=>{t.d(r,{L:()=>o});var a=t(13539),s=t(77234),n=t(83493);let o={adapter:(0,a.N)(n._),providers:[(0,s.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.role=r.role||"EMPLOYEE",e.sub=r.id),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role),e),async signIn({user:e,account:r,profile:t}){if(r?.provider==="google")try{await n._.user.findUnique({where:{email:e.email}})||await n._.user.create({data:{email:e.email,name:e.name,image:e.image,role:"EMPLOYEE"}})}catch(e){return console.error("Erro ao criar usu\xe1rio:",e),!1}return!0}},pages:{signIn:"/auth/signin",error:"/auth/error"},secret:"chronos-secret-key-2024-production-ready"}},83493:(e,r,t)=>{t.d(r,{_:()=>s});let a=require("@prisma/client"),s=globalThis.prisma??new a.PrismaClient},64242:(e,r,t)=>{t.d(r,{RE:()=>l,Sr:()=>c,T4:()=>d,UP:()=>o,vg:()=>i});var a=t(84770),s=t.n(a);let n=process.env.QR_SECRET||"chronos-qr-secret-key-2024";function o(e){let r=s().randomBytes(16).toString("hex"),t=JSON.stringify({machineId:e,timestamp:Date.now(),nonce:r,expiresIn:60,version:"v1"}),a=Buffer.from(t).toString("base64url"),o=s().createHmac("sha256",n).update(a).digest("base64url"),i=`${a}.${o}`;return{payload:a,signature:o,fullQR:i}}function i(e){try{let r=e.split(".");if(2!==r.length)return{isValid:!1,error:"Formato de QR inv\xe1lido"};let[t,a]=r,o=s().createHmac("sha256",n).update(t).digest("base64url");if(!s().timingSafeEqual(Buffer.from(o,"base64url"),Buffer.from(a,"base64url")))return{isValid:!1,error:"Assinatura inv\xe1lida"};let i=Buffer.from(t,"base64url").toString("utf8"),u=JSON.parse(i),d=Date.now(),c=u.timestamp+1e3*u.expiresIn;if(d>c)return{isValid:!1,error:"QR code expirado"};if(!u.machineId||!u.nonce||!u.timestamp)return{isValid:!1,error:"Payload inv\xe1lido"};return{isValid:!0,payload:u}}catch(e){return{isValid:!1,error:"Erro ao validar QR code"}}}let u=new Map;function d(e){let r=Date.now()-3e5;for(let[e,t]of Array.from(u.entries()))t<r&&u.delete(e);return u.has(e)}function c(e){u.set(e,Date.now())}function l(e,r,t,a,n){let o=`${e}:${r}:${t}:${a}:${n||""}`;return s().createHash("sha256").update(o).digest("hex")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9276,5972,8966],()=>t(82821));module.exports=a})();