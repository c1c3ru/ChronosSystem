"use strict";(()=>{var e={};e.id=1546,e.ids=[1546],e.modules={98432:e=>{e.exports=require("bcryptjs")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},82821:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>_,requestAsyncStorage:()=>E,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>R});var a={};t.r(a),t.d(a,{POST:()=>m,dynamic:()=>p});var i=t(49303),o=t(88716),n=t(60670),s=t(87070),d=t(75571),u=t(90455),l=t(83493),c=t(64242);let p="force-dynamic";async function m(e){try{let r=await (0,d.getServerSession)(u.L);if(!r)return s.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let{qrData:t}=await e.json();if(!t)return s.NextResponse.json({error:"QR code \xe9 obrigat\xf3rio"},{status:400});let a=(0,c.vg)(t);if(!a.isValid)return s.NextResponse.json({error:a.error||"QR code inv\xe1lido",code:"INVALID_QR"},{status:400});if(!a.payload)return s.NextResponse.json({error:"Payload n\xe3o encontrado no QR code",code:"MISSING_PAYLOAD"},{status:400});let{machineId:i,nonce:o,timestamp:n,expiresIn:p}=a.payload,m=await l._.qrEvent.findUnique({where:{nonce:o},include:{machine:!0}});if(!m)return s.NextResponse.json({error:"QR code n\xe3o encontrado. Pode ter expirado ou ser inv\xe1lido.",code:"QR_NOT_FOUND"},{status:404});if(m.machineId!==i)return s.NextResponse.json({error:"QR code inv\xe1lido para esta m\xe1quina",code:"INVALID_MACHINE"},{status:400});if(m.used)return s.NextResponse.json({error:"QR code j\xe1 foi utilizado. Gere um novo QR code.",code:"QR_ALREADY_USED"},{status:400});if(new Date>m.expiresAt)return s.NextResponse.json({error:"QR code expirado. Gere um novo QR code.",code:"QR_EXPIRED"},{status:400});if(!m.machine.isActive)return s.NextResponse.json({error:"M\xe1quina n\xe3o est\xe1 ativa",code:"MACHINE_INACTIVE"},{status:400});let f=m.machine,E=await l._.attendanceRecord.findFirst({where:{userId:r.user.id},orderBy:{timestamp:"desc"}}),R=E&&"EXIT"!==E.type?"EXIT":"ENTRY",h=Date.now(),g=new Date(h-6e4);if(await l._.attendanceRecord.findFirst({where:{userId:r.user.id,timestamp:{gte:g},type:R}}))return s.NextResponse.json({error:`Registro de ${"ENTRY"===R?"entrada":"sa\xedda"} j\xe1 feito recentemente. Aguarde 1 minuto.`},{status:400});let _=await l._.attendanceRecord.findFirst({orderBy:{timestamp:"desc"},select:{hash:!0}}),v=(0,c.RE)(r.user.id,i,R,Date.now(),_?.hash),w=await l._.attendanceRecord.create({data:{userId:r.user.id,machineId:i,type:R,timestamp:new Date,qrData:t,hash:v,prevHash:E?.hash},include:{machine:{select:{name:!0,location:!0}}}});await l._.qrEvent.update({where:{id:m.id},data:{used:!0,usedAt:new Date,usedBy:r.user.id}}),await l._.auditLog.create({data:{userId:r.user.id,action:"QR_SCAN_ATTENDANCE",resource:"ATTENDANCE_RECORD",details:`Registro de ${R} via QR code na m\xe1quina ${f.name}`}});let x=s.NextResponse.json({success:!0,record:{id:w.id,type:R,timestamp:w.timestamp,location:f.location,machineName:f.name},message:`${"ENTRY"===R?"Entrada":"Sa\xedda"} registrada com sucesso!`,machine:{name:f.name,location:f.location},_deprecated:{warning:"Esta API est\xe1 deprecated. Use /api/attendance/qr-unified",replacement:"/api/attendance/qr-unified",sunset:"2024-12-31"}});return x.headers.set("X-API-Deprecated","true"),x.headers.set("X-API-Replacement","/api/attendance/qr-unified"),x.headers.set("X-API-Sunset","2024-12-31"),x.headers.set("Warning",'299 - "API deprecated. Use /api/attendance/qr-unified"'),x}catch(e){if(e.message&&e.message.includes("QR_SECRET"))return s.NextResponse.json({error:"Erro de configura\xe7\xe3o do servidor: QR_SECRET n\xe3o est\xe1 configurado",code:"SERVER_CONFIG_ERROR"},{status:500});return s.NextResponse.json({error:"Erro interno do servidor",code:"INTERNAL_ERROR",details:void 0},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/attendance/qr-scan/route",pathname:"/api/attendance/qr-scan",filename:"route",bundlePath:"app/api/attendance/qr-scan/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/attendance/qr-scan/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:E,staticGenerationAsyncStorage:R,serverHooks:h}=f,g="/api/attendance/qr-scan/route";function _(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:R})}},90455:(e,r,t)=>{t.d(r,{L:()=>p});var a=t(13539),i=t(77234),o=t(53797),n=t(98432),s=t.n(n),d=t(83493);let u=process.env.GOOGLE_CLIENT_ID,l=process.env.GOOGLE_CLIENT_SECRET,c=process.env.NEXTAUTH_SECRET;if(!u)throw Error("GOOGLE_CLIENT_ID environment variable is required");if(!l)throw Error("GOOGLE_CLIENT_SECRET environment variable is required");if(!c)throw Error("NEXTAUTH_SECRET environment variable is required");let p={adapter:(0,a.N)(d._),debug:!1,providers:[(0,o.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let r=await d._.user.findUnique({where:{email:e.email}});if(!r||!r.password||!await s().compare(e.password,r.password))return null;return{id:r.id,email:r.email,name:r.name,role:r.role,profileComplete:r.profileComplete,image:r.image}}catch(e){return null}}}),(0,i.Z)({clientId:u,clientSecret:l,allowDangerousEmailAccountLinking:!0,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin",error:"/auth/error"},callbacks:{async jwt({token:e,user:r,account:t,trigger:a}){if((r||"update"===a)&&(r&&(e.role=r.role,e.sub=r.id,e.profileComplete=r.profileComplete),e.sub)){let r=await d._.user.findUnique({where:{id:e.sub},select:{role:!0,profileComplete:!0,name:!0,email:!0}});r&&(e.role=r.role,e.profileComplete=r.profileComplete,e.name=r.name,e.email=r.email)}return e},session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role,e.user.profileComplete=r.profileComplete),e),async signIn({user:e,account:r,profile:t}){if(r?.provider==="google")try{if(!t?.email_verified)return!1;let r=await d._.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,role:!0,profileComplete:!0,image:!0}});if(r)e.id=r.id,e.role=r.role,e.profileComplete=r.profileComplete,e.name=r.name||e.name,e.image=r.image||e.image;else try{let r=await d._.user.create({data:{email:e.email,name:t?.name||e.name||"Usu\xe1rio",image:t?.picture||e.image,role:"EMPLOYEE",profileComplete:!1,createdAt:new Date,updatedAt:new Date}});e.id=r.id,e.role=r.role,e.profileComplete=r.profileComplete,e.name=r.name,e.image=r.image,await d._.auditLog.create({data:{userId:r.id,action:"AUTO_USER_CREATED_GOOGLE",resource:"AUTH",details:`Usu\xe1rio criado automaticamente via Google: ${r.email}`}})}catch(r){try{await d._.auditLog.create({data:{userId:null,action:"FAILED_AUTO_USER_CREATION",resource:"AUTH",details:`Falha ao criar usu\xe1rio automaticamente: ${e.email} - ${r}`}})}catch(e){}return!1}}catch(e){return!1}return!0},async redirect({url:e,baseUrl:r}){if(e.includes("/api/auth/callback/"))return`${r}/`;if(e.startsWith("/"))return`${r}${e}`;try{if(new URL(e).origin===r)return e}catch(e){}return r}},secret:c}},83493:(e,r,t)=>{t.d(r,{_:()=>i});let a=require("@prisma/client"),i=globalThis.prisma??new a.PrismaClient},64242:(e,r,t)=>{t.d(r,{RE:()=>d,UP:()=>n,vg:()=>s});var a=t(84770),i=t.n(a);let o=process.env.QR_SECRET;if(!o)throw Error("QR_SECRET environment variable is required");function n(e,r=60){!function(){if(!o)throw Error("QR_SECRET n\xe3o est\xe1 configurado. Configure a vari\xe1vel de ambiente QR_SECRET.")}();let t=i().randomBytes(16).toString("hex"),a=JSON.stringify({machineId:e,timestamp:Date.now(),nonce:t,expiresIn:r,version:"v1"}),n=Buffer.from(a).toString("base64url"),s=i().createHmac("sha256",o).update(n).digest("base64url"),d=`${n}.${s}`;return{payload:n,signature:s,fullQR:d}}function s(e){try{if(!o)return{isValid:!1,error:"QR_SECRET n\xe3o est\xe1 configurado no servidor"};let r=e.split(".");if(2!==r.length)return{isValid:!1,error:"Formato de QR inv\xe1lido. Esperado: payload.signature"};let[t,a]=r,n=i().createHmac("sha256",o).update(t).digest("base64url");if(!i().timingSafeEqual(Buffer.from(n,"base64url"),Buffer.from(a,"base64url")))return{isValid:!1,error:"Assinatura inv\xe1lida"};let s=Buffer.from(t,"base64url").toString("utf8"),d=JSON.parse(s),u=Date.now(),l=d.timestamp+1e3*d.expiresIn;if(u>l)return{isValid:!1,error:"QR code expirado"};if(!d.machineId||!d.nonce||!d.timestamp)return{isValid:!1,error:"Payload inv\xe1lido"};return{isValid:!0,payload:d}}catch(e){return{isValid:!1,error:"Erro ao validar QR code"}}}function d(e,r,t,a,o){let n=`${e}:${r}:${t}:${a}:${o||""}`;return i().createHash("sha256").update(n).digest("hex")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9276,5972,1083],()=>t(82821));module.exports=a})();