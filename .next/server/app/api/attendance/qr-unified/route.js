"use strict";(()=>{var e={};e.id=8442,e.ids=[8442],e.modules={98432:e=>{e.exports=require("bcryptjs")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},65620:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>C,patchFetch:()=>A,requestAsyncStorage:()=>I,routeModule:()=>v,serverHooks:()=>S,staticGenerationAsyncStorage:()=>q});var a,i={};t.r(i),t.d(i,{POST:()=>N,dynamic:()=>_});var n=t(49303),o=t(88716),s=t(60670),d=t(87070),u=t(75571),c=t(90455),l=t(83493),m=t(64242);let p=new Map;function f(e){return r=>{let t=function(e){let r=e.headers.get("x-forwarded-for");return r?r.split(",")[0].trim():e.headers.get("x-real-ip")||e.ip||"unknown"}(r),a=`rate_limit:${t}`,i=Date.now();(function(e){for(let[r,t]of Array.from(p.entries()))e>t.resetTime&&p.delete(r)})(i);let n=p.get(a);if(!n||i>n.resetTime){let r={count:1,resetTime:i+e.windowMs};return p.set(a,r),{success:!0,limit:e.maxRequests,remaining:e.maxRequests-1,reset:r.resetTime}}return n.count>=e.maxRequests?{success:!1,limit:e.maxRequests,remaining:0,reset:n.resetTime}:(n.count++,p.set(a,n),{success:!0,limit:e.maxRequests,remaining:e.maxRequests-n.count,reset:n.resetTime})}}let g={login:f({windowMs:6e4,maxRequests:5}),twoFactor:f({windowMs:6e4,maxRequests:3}),qrScan:f({windowMs:6e4,maxRequests:20}),general:f({windowMs:6e4,maxRequests:100})};!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG"}(a||(a={}));class h{constructor(e="chronos-system"){this.serviceName=e,this.logLevel=2}sanitizeContext(e){let r={...e};for(let e of["password","token","secret","key","authorization","cookie","session","twoFactorSecret","qrData"])r[e]&&(r[e]="[REDACTED]");if(r.email&&"string"==typeof r.email){let[e,t]=r.email.split("@");e&&t&&(r.email=`${e.substring(0,2)}***@${t}`)}if(r.ip&&"string"==typeof r.ip){let e=r.ip.split(".");4===e.length&&(r.ip=`${e[0]}.${e[1]}.***.***.`)}return r}createLogEntry(e,r,t={}){return{level:e,message:r,context:this.sanitizeContext(t),timestamp:new Date().toISOString(),service:this.serviceName}}formatLog(e){return e.level,JSON.stringify(e)}log(e,r,t={}){if(e<=this.logLevel){let a=this.createLogEntry(e,r,t);this.formatLog(a)}}error(e,r={}){this.log(0,e,r)}warn(e,r={}){this.log(1,e,r)}info(e,r={}){this.log(2,e,r)}debug(e,r={}){this.log(3,e,r)}security(e,r={}){this.error(`SECURITY: ${e}`,{...r,security:!0,action:e})}audit(e,r,t={}){this.info(`AUDIT: ${e} on ${r}`,{...t,audit:!0,action:e,resource:r})}performance(e,r,t={}){this.info(`PERFORMANCE: ${e} took ${r}ms`,{...t,performance:!0,operation:e,duration:r})}}new h,new h("auth"),new h("qr-scanner");let R=new h("api");new h("database");let E={start:"08:00",end:"17:00",lunchStart:"12:00",lunchEnd:"13:00"};function w(e){let[r,t]=e.split(":").map(Number);return 60*r+t}function y(e,r){return Math.abs(r.getTime()-e.getTime())/6e4}function x(e){let r=e.getDay();return 0===r||6===r}async function T(e){return E}let _="force-dynamic";async function N(e){let r=g.qrScan(e);if(!r.success)return R.warn("Rate limit exceeded for QR scan",{ip:e.headers.get("x-forwarded-for")||"unknown",remaining:r.remaining}),new Response(JSON.stringify({error:"Muitas tentativas. Tente novamente em alguns segundos.",retryAfter:Math.ceil((r.reset-Date.now())/1e3),code:"RATE_LIMIT_EXCEEDED"}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":r.limit.toString(),"X-RateLimit-Remaining":r.remaining.toString(),"Retry-After":Math.ceil((r.reset-Date.now())/1e3).toString()}});try{let r;let t=await (0,u.getServerSession)(c.L);if(!t)return R.warn("Unauthorized QR scan attempt",{ip:e.headers.get("x-forwarded-for")||"unknown"}),d.NextResponse.json({error:"N\xe3o autenticado",code:"UNAUTHORIZED"},{status:401});let{qrData:a,location:i}=await e.json();if(!a)return d.NextResponse.json({error:"QR code \xe9 obrigat\xf3rio",code:"MISSING_QR_DATA"},{status:400});let n=!1,o=null,s=(0,m.vg)(a);if(s.isValid&&s.payload){n=!0,r=s.payload.machineId;let{nonce:e,timestamp:t,expiresIn:a}=s.payload;if(!(o=await l._.qrEvent.findUnique({where:{nonce:e},include:{machine:!0}})))return d.NextResponse.json({error:"QR code n\xe3o encontrado. Pode ter expirado ou ser inv\xe1lido.",code:"QR_NOT_FOUND"},{status:404});if(o.machineId!==r)return d.NextResponse.json({error:"QR code inv\xe1lido para esta m\xe1quina",code:"INVALID_MACHINE"},{status:400});if(o.used)return d.NextResponse.json({error:"QR code j\xe1 foi utilizado. Gere um novo QR code.",code:"QR_ALREADY_USED"},{status:400});if(new Date>o.expiresAt)return d.NextResponse.json({error:"QR code expirado. Gere um novo QR code.",code:"QR_EXPIRED"},{status:400});if(!o.machine.isActive)return d.NextResponse.json({error:"M\xe1quina n\xe3o est\xe1 ativa",code:"MACHINE_INACTIVE"},{status:400})}else try{let e=JSON.parse(a);if(!(r=e.machineId||e.id))throw Error("machineId n\xe3o encontrado no JSON");if(e.expires&&Date.now()>e.expires)return d.NextResponse.json({error:"QR code expirado",code:"QR_EXPIRED"},{status:400});if(e.nonce&&(o=await l._.qrEvent.findUnique({where:{nonce:e.nonce},include:{machine:!0}}))&&o.used)return d.NextResponse.json({error:"QR code j\xe1 foi utilizado",code:"QR_ALREADY_USED"},{status:400})}catch{r=a.trim()}let p=await l._.machine.findFirst({where:{id:r,isActive:!0}});if(!p)return d.NextResponse.json({error:`M\xe1quina '${r}' n\xe3o encontrada ou inativa`,code:"MACHINE_NOT_FOUND"},{status:400});let f=await l._.attendanceRecord.findFirst({where:{userId:t.user.id},orderBy:{timestamp:"desc"}}),g=await T(t.user.id),h=new Date,E=function(e){let{currentTime:r,lastRecord:t,workingHours:a,isWeekend:i,isHoliday:n}=e,o=60*r.getHours()+r.getMinutes(),s=w(a.start),d=w(a.end),u=w(a.lunchStart),c=w(a.lunchEnd);if(!t)return{type:"ENTRY",reason:"Primeiro registro do usu\xe1rio",confidence:"high"};if(t.timestamp.toDateString()!==r.toDateString())return{type:"ENTRY",reason:"Novo dia de trabalho",confidence:"high"};let l=y(t.timestamp,r);if(l>240)return{type:"ENTRY",reason:`Intervalo longo desde \xfaltimo registro (${Math.floor(l/60)}h)`,confidence:"high"};switch(o<s-60?"night":o<s?"before_work":o<u?"work_morning":o<c?"lunch_time":o<d?"work_afternoon":o<d+120?"after_work":"night"){case"before_work":if("EXIT"===t.type)return{type:"ENTRY",reason:"Entrada antecipada (antes do hor\xe1rio normal)",confidence:"high"};return{type:"EXIT",reason:"Sa\xedda muito cedo (poss\xedvel erro)",confidence:"low",suggestions:["Verifique se realmente deseja registrar sa\xedda antes do hor\xe1rio de trabalho"]};case"work_morning":if("EXIT"===t.type)return{type:"ENTRY",reason:"Entrada no per\xedodo da manh\xe3",confidence:"high"};if(o>=u-30)return{type:"EXIT",reason:"Sa\xedda para almo\xe7o",confidence:"high"};return{type:"EXIT",reason:"Sa\xedda durante per\xedodo da manh\xe3 (pausa/emerg\xeancia)",confidence:"medium",suggestions:["Confirme se \xe9 uma sa\xedda tempor\xe1ria ou fim do expediente"]};case"lunch_time":if("ENTRY"===t.type)return{type:"EXIT",reason:"Sa\xedda para almo\xe7o",confidence:"high"};return{type:"ENTRY",reason:"Retorno do almo\xe7o",confidence:"high"};case"work_afternoon":if("EXIT"===t.type)return{type:"ENTRY",reason:"Entrada no per\xedodo da tarde",confidence:"high"};if(o>=d-60)return{type:"EXIT",reason:"Sa\xedda do expediente",confidence:"high"};return{type:"EXIT",reason:"Sa\xedda durante per\xedodo da tarde (pausa/emerg\xeancia)",confidence:"medium",suggestions:["Confirme se \xe9 uma sa\xedda tempor\xe1ria ou fim do expediente"]};case"after_work":if("ENTRY"===t.type)return{type:"EXIT",reason:"Sa\xedda ap\xf3s hor\xe1rio normal (hora extra)",confidence:"high"};return{type:"ENTRY",reason:"Entrada fora do hor\xe1rio (hora extra/plant\xe3o)",confidence:"medium",suggestions:["Confirme se \xe9 trabalho extra autorizado"]};case"night":return{type:"ENTRY"===t.type?"EXIT":"ENTRY",reason:"Registro noturno (plant\xe3o/emerg\xeancia)",confidence:"low",suggestions:["Verifique se \xe9 trabalho noturno autorizado"]}}return{type:"ENTRY"===t.type?"EXIT":"ENTRY",reason:"Altern\xe2ncia simples (fallback)",confidence:"low"}}({userId:t.user.id,currentTime:h,lastRecord:f?{type:f.type,timestamp:f.timestamp}:null,workingHours:g,isWeekend:x(h)}),_=E.type,N=function(e,r){let t=[],a=[],{currentTime:i,lastRecord:n,workingHours:o}=e;if(n){let e=y(n.timestamp,i);e<5&&a.push(`Registro muito pr\xf3ximo do anterior (${Math.floor(e)} minutos)`)}let s=i.getHours();return(s<6||s>22)&&t.push("Registro em hor\xe1rio n\xe3o convencional"),x(i)&&t.push("Registro em fim de semana"),{isValid:0===a.length,warnings:t,errors:a}}({userId:t.user.id,currentTime:h,lastRecord:f?{type:f.type,timestamp:f.timestamp}:null,workingHours:g,isWeekend:x(h)},0);if(!N.isValid)return d.NextResponse.json({error:`Registro bloqueado: ${N.errors.join(", ")}`,warnings:N.warnings,code:"VALIDATION_FAILED"},{status:400});let v=Date.now(),I=new Date(v-6e4);if(await l._.attendanceRecord.findFirst({where:{userId:t.user.id,timestamp:{gte:I},type:_}}))return d.NextResponse.json({error:`Registro de ${"ENTRY"===_?"entrada":"sa\xedda"} j\xe1 feito recentemente. Aguarde 1 minuto.`,code:"DUPLICATE_RECORD"},{status:400});let q=await l._.attendanceRecord.findFirst({orderBy:{timestamp:"desc"},select:{hash:!0}}),S=(0,m.RE)(t.user.id,r,_,Date.now(),q?.hash),C=await l._.attendanceRecord.create({data:{userId:t.user.id,machineId:r,type:_,timestamp:new Date,qrData:a,hash:S,prevHash:f?.hash,latitude:i?.latitude,longitude:i?.longitude},include:{machine:{select:{name:!0,location:!0}}}});n&&o&&await l._.qrEvent.update({where:{id:o.id},data:{used:!0,usedAt:new Date,usedBy:t.user.id}}),!n&&o&&await l._.qrEvent.update({where:{id:o.id},data:{used:!0,usedAt:new Date,usedBy:t.user.id}}),await l._.auditLog.create({data:{userId:t.user.id,action:"QR_UNIFIED_ATTENDANCE",resource:"ATTENDANCE_RECORD",details:`Registro de ${_} via QR ${n?"seguro":"simples"} na m\xe1quina ${p.name}`}});let A=C.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return d.NextResponse.json({success:!0,record:{id:C.id,type:_,timestamp:C.timestamp,time:A,location:p.location,machineName:p.name},qrType:n?"SECURE":"SIMPLE",analysis:{reason:E.reason,confidence:E.confidence,suggestions:E.suggestions||[],warnings:N.warnings},machine:{name:p.name,location:p.location},message:`${"ENTRY"===_?"Entrada":"Sa\xedda"} registrada com sucesso \xe0s ${A}!`,smartMessage:`${"ENTRY"===_?"Entrada":"Sa\xedda"} detectada: ${E.reason}`})}catch(e){if(R.error("QR scan processing error",{error:e.message,stack:e.stack,userId:(await u.getServerSession(c.L))?.user?.id}),e.message&&e.message.includes("QR_SECRET"))return d.NextResponse.json({error:"Erro de configura\xe7\xe3o do servidor: QR_SECRET n\xe3o est\xe1 configurado",code:"SERVER_CONFIG_ERROR"},{status:500});return d.NextResponse.json({error:"Erro interno do servidor",code:"INTERNAL_ERROR",details:void 0},{status:500})}}let v=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/attendance/qr-unified/route",pathname:"/api/attendance/qr-unified",filename:"route",bundlePath:"app/api/attendance/qr-unified/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/attendance/qr-unified/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:I,staticGenerationAsyncStorage:q,serverHooks:S}=v,C="/api/attendance/qr-unified/route";function A(){return(0,s.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:q})}},90455:(e,r,t)=>{t.d(r,{L:()=>m});var a=t(13539),i=t(77234),n=t(53797),o=t(98432),s=t.n(o),d=t(83493);let u=process.env.GOOGLE_CLIENT_ID,c=process.env.GOOGLE_CLIENT_SECRET,l=process.env.NEXTAUTH_SECRET;if(!u)throw Error("GOOGLE_CLIENT_ID environment variable is required");if(!c)throw Error("GOOGLE_CLIENT_SECRET environment variable is required");if(!l)throw Error("NEXTAUTH_SECRET environment variable is required");let m={adapter:(0,a.N)(d._),debug:!1,providers:[(0,n.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let r=await d._.user.findUnique({where:{email:e.email}});if(!r||!r.password||!await s().compare(e.password,r.password))return null;return{id:r.id,email:r.email,name:r.name,role:r.role,profileComplete:r.profileComplete,image:r.image}}catch(e){return null}}}),(0,i.Z)({clientId:u,clientSecret:c,allowDangerousEmailAccountLinking:!0,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin",error:"/auth/error"},callbacks:{async jwt({token:e,user:r,account:t,trigger:a}){if((r||"update"===a)&&(r&&(e.role=r.role,e.sub=r.id,e.profileComplete=r.profileComplete),e.sub)){let r=await d._.user.findUnique({where:{id:e.sub},select:{role:!0,profileComplete:!0,name:!0,email:!0}});r&&(e.role=r.role,e.profileComplete=r.profileComplete,e.name=r.name,e.email=r.email)}return e},session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role,e.user.profileComplete=r.profileComplete),e),async signIn({user:e,account:r,profile:t}){if(r?.provider==="google")try{if(!t?.email_verified)return!1;let r=await d._.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,role:!0,profileComplete:!0,image:!0}});if(r)e.id=r.id,e.role=r.role,e.profileComplete=r.profileComplete,e.name=r.name||e.name,e.image=r.image||e.image;else try{let r=await d._.user.create({data:{email:e.email,name:t?.name||e.name||"Usu\xe1rio",image:t?.picture||e.image,role:"EMPLOYEE",profileComplete:!1,createdAt:new Date,updatedAt:new Date}});e.id=r.id,e.role=r.role,e.profileComplete=r.profileComplete,e.name=r.name,e.image=r.image,await d._.auditLog.create({data:{userId:r.id,action:"AUTO_USER_CREATED_GOOGLE",resource:"AUTH",details:`Usu\xe1rio criado automaticamente via Google: ${r.email}`}})}catch(r){try{await d._.auditLog.create({data:{userId:null,action:"FAILED_AUTO_USER_CREATION",resource:"AUTH",details:`Falha ao criar usu\xe1rio automaticamente: ${e.email} - ${r}`}})}catch(e){}return!1}}catch(e){return!1}return!0},async redirect({url:e,baseUrl:r}){if(e.includes("/api/auth/callback/"))return`${r}/`;if(e.startsWith("/"))return`${r}${e}`;try{if(new URL(e).origin===r)return e}catch(e){}return r}},secret:l}},83493:(e,r,t)=>{t.d(r,{_:()=>i});let a=require("@prisma/client"),i=globalThis.prisma??new a.PrismaClient},64242:(e,r,t)=>{t.d(r,{RE:()=>d,UP:()=>o,vg:()=>s});var a=t(84770),i=t.n(a);let n=process.env.QR_SECRET;if(!n)throw Error("QR_SECRET environment variable is required");function o(e,r=60){!function(){if(!n)throw Error("QR_SECRET n\xe3o est\xe1 configurado. Configure a vari\xe1vel de ambiente QR_SECRET.")}();let t=i().randomBytes(16).toString("hex"),a=JSON.stringify({machineId:e,timestamp:Date.now(),nonce:t,expiresIn:r,version:"v1"}),o=Buffer.from(a).toString("base64url"),s=i().createHmac("sha256",n).update(o).digest("base64url"),d=`${o}.${s}`;return{payload:o,signature:s,fullQR:d}}function s(e){try{if(!n)return{isValid:!1,error:"QR_SECRET n\xe3o est\xe1 configurado no servidor"};let r=e.split(".");if(2!==r.length)return{isValid:!1,error:"Formato de QR inv\xe1lido. Esperado: payload.signature"};let[t,a]=r,o=i().createHmac("sha256",n).update(t).digest("base64url");if(!i().timingSafeEqual(Buffer.from(o,"base64url"),Buffer.from(a,"base64url")))return{isValid:!1,error:"Assinatura inv\xe1lida"};let s=Buffer.from(t,"base64url").toString("utf8"),d=JSON.parse(s),u=Date.now(),c=d.timestamp+1e3*d.expiresIn;if(u>c)return{isValid:!1,error:"QR code expirado"};if(!d.machineId||!d.nonce||!d.timestamp)return{isValid:!1,error:"Payload inv\xe1lido"};return{isValid:!0,payload:d}}catch(e){return{isValid:!1,error:"Erro ao validar QR code"}}}function d(e,r,t,a,n){let o=`${e}:${r}:${t}:${a}:${n||""}`;return i().createHash("sha256").update(o).digest("hex")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9276,5972,1083],()=>t(65620));module.exports=a})();