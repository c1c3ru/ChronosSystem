"use strict";(()=>{var e={};e.id=8463,e.ids=[8463],e.modules={98432:e=>{e.exports=require("bcryptjs")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},57017:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>C,requestAsyncStorage:()=>S,routeModule:()=>q,serverHooks:()=>I,staticGenerationAsyncStorage:()=>_});var i,a={};r.r(a),r.d(a,{POST:()=>v,dynamic:()=>N});var n=r(49303),o=r(88716),s=r(60670),u=r(87070),l=r(75571),d=r(90455),c=r(83493),m=r(64242);let p=new Map;function f(e){return t=>{let r=function(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0].trim():e.headers.get("x-real-ip")||e.ip||"unknown"}(t),i=`rate_limit:${r}`,a=Date.now();(function(e){for(let[t,r]of Array.from(p.entries()))e>r.resetTime&&p.delete(t)})(a);let n=p.get(i);if(!n||a>n.resetTime){let t={count:1,resetTime:a+e.windowMs};return p.set(i,t),{success:!0,limit:e.maxRequests,remaining:e.maxRequests-1,reset:t.resetTime}}return n.count>=e.maxRequests?{success:!1,limit:e.maxRequests,remaining:0,reset:n.resetTime}:(n.count++,p.set(i,n),{success:!0,limit:e.maxRequests,remaining:e.maxRequests-n.count,reset:n.resetTime})}}let g={login:f({windowMs:6e4,maxRequests:5}),twoFactor:f({windowMs:6e4,maxRequests:3}),qrScan:f({windowMs:6e4,maxRequests:20}),general:f({windowMs:6e4,maxRequests:100})};!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG"}(i||(i={}));class h{constructor(e="chronos-system"){this.serviceName=e,this.logLevel=2}sanitizeContext(e){let t={...e};for(let e of["password","token","secret","key","authorization","cookie","session","twoFactorSecret","qrData"])t[e]&&(t[e]="[REDACTED]");if(t.email&&"string"==typeof t.email){let[e,r]=t.email.split("@");e&&r&&(t.email=`${e.substring(0,2)}***@${r}`)}if(t.ip&&"string"==typeof t.ip){let e=t.ip.split(".");4===e.length&&(t.ip=`${e[0]}.${e[1]}.***.***.`)}return t}createLogEntry(e,t,r={}){return{level:e,message:t,context:this.sanitizeContext(r),timestamp:new Date().toISOString(),service:this.serviceName}}formatLog(e){return e.level,JSON.stringify(e)}log(e,t,r={}){if(e<=this.logLevel){let i=this.createLogEntry(e,t,r);this.formatLog(i)}}error(e,t={}){this.log(0,e,t)}warn(e,t={}){this.log(1,e,t)}info(e,t={}){this.log(2,e,t)}debug(e,t={}){this.log(3,e,t)}security(e,t={}){this.error(`SECURITY: ${e}`,{...t,security:!0,action:e})}audit(e,t,r={}){this.info(`AUDIT: ${e} on ${t}`,{...r,audit:!0,action:e,resource:t})}performance(e,t,r={}){this.info(`PERFORMANCE: ${e} took ${t}ms`,{...r,performance:!0,operation:e,duration:t})}}new h,new h("auth"),new h("qr-scanner");let w=new h("api");new h("database");let E={start:"08:00",end:"17:00",lunchStart:"12:00",lunchEnd:"13:00"};function R(e){let[t,r]=e.split(":").map(Number);return 60*t+r}function y(e,t){return Math.abs(t.getTime()-e.getTime())/6e4}function x(e){let t=e.getDay();return 0===t||6===t}async function T(e){return E}let N="force-dynamic";async function v(e){let t=g.qrScan(e);if(!t.success)return w.warn("Rate limit exceeded for QR scan",{ip:e.headers.get("x-forwarded-for")||"unknown",remaining:t.remaining}),new Response(JSON.stringify({error:"Muitas tentativas. Tente novamente em alguns segundos.",retryAfter:Math.ceil((t.reset-Date.now())/1e3)}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":t.limit.toString(),"X-RateLimit-Remaining":t.remaining.toString(),"Retry-After":Math.ceil((t.reset-Date.now())/1e3).toString()}});try{let t;let r=await (0,l.getServerSession)(d.L);if(!r)return w.warn("Unauthorized QR scan attempt",{ip:e.headers.get("x-forwarded-for")||"unknown"}),u.NextResponse.json({error:"N\xe3o autenticado"},{status:401});let{qrData:i}=await e.json();if(!i)return u.NextResponse.json({error:"QR code \xe9 obrigat\xf3rio"},{status:400});let a=(0,m.vg)(i);if(a.isValid&&a.payload)t=a.payload.machineId;else try{let e=JSON.parse(i);if(!(t=e.machineId||e.id))throw Error("machineId n\xe3o encontrado no JSON")}catch{t=i.trim()}let n=await c._.machine.findFirst({where:{id:t,isActive:!0}});if(!n)return u.NextResponse.json({error:`M\xe1quina '${t}' n\xe3o encontrada ou inativa`},{status:400});let o=await c._.attendanceRecord.findFirst({where:{userId:r.user.id},orderBy:{timestamp:"desc"}}),s=await T(r.user.id),p=new Date,f=function(e){let{currentTime:t,lastRecord:r,workingHours:i,isWeekend:a,isHoliday:n}=e,o=60*t.getHours()+t.getMinutes(),s=R(i.start),u=R(i.end),l=R(i.lunchStart),d=R(i.lunchEnd);if(!r)return{type:"ENTRY",reason:"Primeiro registro do usu\xe1rio",confidence:"high"};if(r.timestamp.toDateString()!==t.toDateString())return{type:"ENTRY",reason:"Novo dia de trabalho",confidence:"high"};let c=y(r.timestamp,t);if(c>240)return{type:"ENTRY",reason:`Intervalo longo desde \xfaltimo registro (${Math.floor(c/60)}h)`,confidence:"high"};switch(o<s-60?"night":o<s?"before_work":o<l?"work_morning":o<d?"lunch_time":o<u?"work_afternoon":o<u+120?"after_work":"night"){case"before_work":if("EXIT"===r.type)return{type:"ENTRY",reason:"Entrada antecipada (antes do hor\xe1rio normal)",confidence:"high"};return{type:"EXIT",reason:"Sa\xedda muito cedo (poss\xedvel erro)",confidence:"low",suggestions:["Verifique se realmente deseja registrar sa\xedda antes do hor\xe1rio de trabalho"]};case"work_morning":if("EXIT"===r.type)return{type:"ENTRY",reason:"Entrada no per\xedodo da manh\xe3",confidence:"high"};if(o>=l-30)return{type:"EXIT",reason:"Sa\xedda para almo\xe7o",confidence:"high"};return{type:"EXIT",reason:"Sa\xedda durante per\xedodo da manh\xe3 (pausa/emerg\xeancia)",confidence:"medium",suggestions:["Confirme se \xe9 uma sa\xedda tempor\xe1ria ou fim do expediente"]};case"lunch_time":if("ENTRY"===r.type)return{type:"EXIT",reason:"Sa\xedda para almo\xe7o",confidence:"high"};return{type:"ENTRY",reason:"Retorno do almo\xe7o",confidence:"high"};case"work_afternoon":if("EXIT"===r.type)return{type:"ENTRY",reason:"Entrada no per\xedodo da tarde",confidence:"high"};if(o>=u-60)return{type:"EXIT",reason:"Sa\xedda do expediente",confidence:"high"};return{type:"EXIT",reason:"Sa\xedda durante per\xedodo da tarde (pausa/emerg\xeancia)",confidence:"medium",suggestions:["Confirme se \xe9 uma sa\xedda tempor\xe1ria ou fim do expediente"]};case"after_work":if("ENTRY"===r.type)return{type:"EXIT",reason:"Sa\xedda ap\xf3s hor\xe1rio normal (hora extra)",confidence:"high"};return{type:"ENTRY",reason:"Entrada fora do hor\xe1rio (hora extra/plant\xe3o)",confidence:"medium",suggestions:["Confirme se \xe9 trabalho extra autorizado"]};case"night":return{type:"ENTRY"===r.type?"EXIT":"ENTRY",reason:"Registro noturno (plant\xe3o/emerg\xeancia)",confidence:"low",suggestions:["Verifique se \xe9 trabalho noturno autorizado"]}}return{type:"ENTRY"===r.type?"EXIT":"ENTRY",reason:"Altern\xe2ncia simples (fallback)",confidence:"low"}}({userId:r.user.id,currentTime:p,lastRecord:o?{type:o.type,timestamp:o.timestamp}:null,workingHours:s,isWeekend:x(p)}),g=f.type,h=function(e,t){let r=[],i=[],{currentTime:a,lastRecord:n,workingHours:o}=e;if(n){let e=y(n.timestamp,a);e<5&&i.push(`Registro muito pr\xf3ximo do anterior (${Math.floor(e)} minutos)`)}let s=a.getHours();return(s<6||s>22)&&r.push("Registro em hor\xe1rio n\xe3o convencional"),x(a)&&r.push("Registro em fim de semana"),{isValid:0===i.length,warnings:r,errors:i}}({userId:r.user.id,currentTime:p,lastRecord:o?{type:o.type,timestamp:o.timestamp}:null,workingHours:s,isWeekend:x(p)},0);if(!h.isValid)return u.NextResponse.json({error:`Registro bloqueado: ${h.errors.join(", ")}`,warnings:h.warnings},{status:400});let E=Date.now(),N=new Date(E-6e4);if(await c._.attendanceRecord.findFirst({where:{userId:r.user.id,timestamp:{gte:N},type:g}}))return u.NextResponse.json({error:`Registro de ${"ENTRY"===g?"entrada":"sa\xedda"} j\xe1 feito recentemente. Aguarde 1 minuto.`},{status:400});let v=await c._.attendanceRecord.findFirst({orderBy:{timestamp:"desc"},select:{hash:!0}}),q=(0,m.RE)(r.user.id,t,g,Date.now(),v?.hash),S=await c._.attendanceRecord.create({data:{userId:r.user.id,machineId:t,type:g,timestamp:new Date,qrData:i,hash:q}});await c._.auditLog.create({data:{userId:r.user.id,action:"SIMPLE_QR_ATTENDANCE",resource:"ATTENDANCE_RECORD",details:`Registro de ${g} via QR simples na m\xe1quina ${n.name}`}});let _=S.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return u.NextResponse.json({success:!0,record:{id:S.id,type:g,timestamp:S.timestamp,time:_,location:n.location,machineName:n.name},analysis:{reason:f.reason,confidence:f.confidence,suggestions:f.suggestions||[],warnings:h.warnings},message:`${"ENTRY"===g?"Entrada":"Sa\xedda"} registrada com sucesso \xe0s ${_}!`,smartMessage:`${"ENTRY"===g?"Entrada":"Sa\xedda"} detectada: ${f.reason}`})}catch(e){return u.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let q=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/attendance/simple-register/route",pathname:"/api/attendance/simple-register",filename:"route",bundlePath:"app/api/attendance/simple-register/route"},resolvedPagePath:"/home/deppi/ChronosSystem/app/api/attendance/simple-register/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:S,staticGenerationAsyncStorage:_,serverHooks:I}=q,b="/api/attendance/simple-register/route";function C(){return(0,s.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:_})}},90455:(e,t,r)=>{r.d(t,{L:()=>m});var i=r(13539),a=r(77234),n=r(53797),o=r(98432),s=r.n(o),u=r(83493);let l=process.env.GOOGLE_CLIENT_ID,d=process.env.GOOGLE_CLIENT_SECRET,c=process.env.NEXTAUTH_SECRET;if(!l)throw Error("GOOGLE_CLIENT_ID environment variable is required");if(!d)throw Error("GOOGLE_CLIENT_SECRET environment variable is required");if(!c)throw Error("NEXTAUTH_SECRET environment variable is required");let m={adapter:(0,i.N)(u._),debug:!1,providers:[(0,n.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=await u._.user.findUnique({where:{email:e.email}});if(!t||!t.password||!await s().compare(e.password,t.password))return null;return{id:t.id,email:t.email,name:t.name,role:t.role,profileComplete:t.profileComplete,image:t.image}}catch(e){return null}}}),(0,a.Z)({clientId:l,clientSecret:d,allowDangerousEmailAccountLinking:!0,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin",error:"/auth/error"},callbacks:{async jwt({token:e,user:t,account:r,trigger:i}){if((t||"update"===i)&&(t&&(e.role=t.role,e.sub=t.id,e.profileComplete=t.profileComplete),e.sub)){let t=await u._.user.findUnique({where:{id:e.sub},select:{role:!0,profileComplete:!0,name:!0,email:!0}});t&&(e.role=t.role,e.profileComplete=t.profileComplete,e.name=t.name,e.email=t.email)}return e},session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.profileComplete=t.profileComplete),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{if(!r?.email_verified)return!1;let t=await u._.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,role:!0,profileComplete:!0,image:!0}});if(t)e.id=t.id,e.role=t.role,e.profileComplete=t.profileComplete,e.name=t.name||e.name,e.image=t.image||e.image;else{try{await u._.auditLog.create({data:{userId:null,action:"UNAUTHORIZED_GOOGLE_LOGIN_ATTEMPT",resource:"AUTH",details:`Tentativa de login Google n\xe3o autorizada: ${e.email}`}})}catch(e){}return!1}}catch(e){return!1}return!0},async redirect({url:e,baseUrl:t}){if(e.includes("/api/auth/callback/"))return`${t}/`;if(e.startsWith("/"))return`${t}${e}`;try{if(new URL(e).origin===t)return e}catch(e){}return t}},secret:c}},83493:(e,t,r)=>{r.d(t,{_:()=>a});let i=require("@prisma/client"),a=globalThis.prisma??new i.PrismaClient},64242:(e,t,r)=>{r.d(t,{RE:()=>c,Sr:()=>d,T4:()=>l,UP:()=>o,vg:()=>s});var i=r(84770),a=r.n(i);let n=process.env.QR_SECRET;if(!n)throw Error("QR_SECRET environment variable is required");function o(e){let t=a().randomBytes(16).toString("hex"),r=JSON.stringify({machineId:e,timestamp:Date.now(),nonce:t,expiresIn:300,version:"v1"}),i=Buffer.from(r).toString("base64url"),o=a().createHmac("sha256",n).update(i).digest("base64url"),s=`${i}.${o}`;return{payload:i,signature:o,fullQR:s}}function s(e){try{let t=e.split(".");if(2!==t.length)return{isValid:!1,error:"Formato de QR inv\xe1lido"};let[r,i]=t,o=a().createHmac("sha256",n).update(r).digest("base64url");if(!a().timingSafeEqual(Buffer.from(o,"base64url"),Buffer.from(i,"base64url")))return{isValid:!1,error:"Assinatura inv\xe1lida"};let s=Buffer.from(r,"base64url").toString("utf8"),u=JSON.parse(s),l=Date.now(),d=u.timestamp+1e3*u.expiresIn;if(l>d)return{isValid:!1,error:"QR code expirado"};if(!u.machineId||!u.nonce||!u.timestamp)return{isValid:!1,error:"Payload inv\xe1lido"};return{isValid:!0,payload:u}}catch(e){return{isValid:!1,error:"Erro ao validar QR code"}}}let u=new Map;function l(e){let t=Date.now()-3e5;for(let[e,r]of Array.from(u.entries()))r<t&&u.delete(e);return u.has(e)}function d(e){u.set(e,Date.now())}function c(e,t,r,i,n){let o=`${e}:${t}:${r}:${i}:${n||""}`;return a().createHash("sha256").update(o).digest("hex")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,1083],()=>r(57017));module.exports=i})();