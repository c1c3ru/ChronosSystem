# Configuração Apache para ChronosSystem
# Coloque este arquivo em /etc/apache2/sites-available/ e ative com a2ensite

# Habilitar módulos necessários:
# sudo a2enmod rewrite
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod headers
# sudo a2enmod deflate
# sudo a2enmod expires

# Frontend Admin
<VirtualHost *:80>
    ServerName admin.chronos.local
    DocumentRoot /var/www/chronos/frontend-admin/dist
    
    # Redirecionar para HTTPS (descomente em produção)
    # Redirect permanent / https://admin.chronos.local/
    
    <Directory /var/www/chronos/frontend-admin/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Configuração para SPA
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Cache para assets estáticos
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header append Cache-Control "public, immutable"
    </LocationMatch>
    
    # Compressão
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    ErrorLog ${APACHE_LOG_DIR}/chronos-admin-error.log
    CustomLog ${APACHE_LOG_DIR}/chronos-admin-access.log combined
</VirtualHost>

# PWA Estagiário
<VirtualHost *:80>
    ServerName pwa.chronos.local
    DocumentRoot /var/www/chronos/pwa-estagiario/dist
    
    <Directory /var/www/chronos/pwa-estagiario/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Configuração para PWA
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        
        # Headers para PWA
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </Directory>
    
    # Service Worker - não deve ser cacheado
    <LocationMatch "sw\.js$">
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </LocationMatch>
    
    # Manifest e ícones PWA
    <LocationMatch "\.(webmanifest|json)$">
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
    </LocationMatch>
    
    # Cache para outros assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header append Cache-Control "public, immutable"
    </LocationMatch>
    
    # Compressão
    <Location />
        SetOutputFilter DEFLATE
    </Location>
    
    ErrorLog ${APACHE_LOG_DIR}/chronos-pwa-error.log
    CustomLog ${APACHE_LOG_DIR}/chronos-pwa-access.log combined
</VirtualHost>

# Kiosk
<VirtualHost *:80>
    ServerName kiosk.chronos.local
    DocumentRoot /var/www/chronos/kiosk/dist
    
    <Directory /var/www/chronos/kiosk/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Cache para assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header append Cache-Control "public, immutable"
    </LocationMatch>
    
    # Compressão
    <Location />
        SetOutputFilter DEFLATE
    </Location>
    
    ErrorLog ${APACHE_LOG_DIR}/chronos-kiosk-error.log
    CustomLog ${APACHE_LOG_DIR}/chronos-kiosk-access.log combined
</VirtualHost>

# API Backend (Proxy Reverso)
<VirtualHost *:80>
    ServerName api.chronos.local
    
    # Rate limiting (requer mod_evasive)
    # DOSHashTableSize    2048
    # DOSPageCount        5
    # DOSSiteCount        50
    # DOSPageInterval     1
    # DOSSiteInterval     1
    # DOSBlockingPeriod   600
    
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Proxy para o backend Node.js
    ProxyPass / http://127.0.0.1:4000/
    ProxyPassReverse / http://127.0.0.1:4000/
    
    # Headers para proxy
    ProxyPassReverse / http://127.0.0.1:4000/
    ProxyPassReverseMatch ^/(.*) http://127.0.0.1:4000/$1
    
    <Proxy *>
        Require all granted
    </Proxy>
    
    # Timeout
    ProxyTimeout 60
    
    ErrorLog ${APACHE_LOG_DIR}/chronos-api-error.log
    CustomLog ${APACHE_LOG_DIR}/chronos-api-access.log combined
</VirtualHost>

# Configuração HTTPS (descomente e configure certificados SSL)
# <VirtualHost *:443>
#     ServerName admin.chronos.local
#     DocumentRoot /var/www/chronos/frontend-admin/dist
#     
#     SSLEngine on
#     SSLCertificateFile /path/to/certificate.crt
#     SSLCertificateKeyFile /path/to/private.key
#     SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
#     
#     <Directory /var/www/chronos/frontend-admin/dist>
#         Options -Indexes +FollowSymLinks
#         AllowOverride All
#         Require all granted
#         
#         RewriteEngine On
#         RewriteBase /
#         RewriteRule ^index\.html$ - [L]
#         RewriteCond %{REQUEST_FILENAME} !-f
#         RewriteCond %{REQUEST_FILENAME} !-d
#         RewriteRule . /index.html [L]
#     </Directory>
# </VirtualHost>
